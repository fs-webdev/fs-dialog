<link rel="import" href="../fs-globals/fs-globals.html">
<link rel="import" href="../fs-dialog/fs-dialog-base.html">
<script src="../fs-dialog/fs-dialog-positioning-obj.js"></script>

<style data-fs-anchored-dialog="">

  fs-anchored-dialog {
    position: absolute;
  }

  fs-anchored-dialog .fs-dialog-pointer {
   /* TODO: after we drop IE, add back in the border, content, height, and width */
   /* border: 16px solid transparent;
    content: '';
    height: 0;
    width: 0;*/
    overflow: visible;
    position: absolute;
   /* TODO: after we drop IE, remove the box-shadow, background-color, height, width, transform, and z-index */
    box-shadow: 0px 0px 4px 0px rgba(0,0,0,0.35), 0px 3px 2px 0px rgba(0,0,0,0.18);
    background-color: #fff;
    height: 22.62px;
    width: 22.62px;
    transform: rotate(45deg);
    z-index: -1;
  }
  fs-anchored-dialog[pointer-direction="up"] .fs-dialog-pointer {
   /* TODO: after we drop IE, change 11.31px to 16px */
    left: calc(50% - 11.31px);
    top: -11.31px;
    border-bottom-color: #FFF;
    border-top-width: 0;
  }
  fs-anchored-dialog[pointer-direction="down"] .fs-dialog-pointer {
   /* TODO: after we drop IE, change 11.31px to 16px */
    left: calc(50% - 11.31px);
    bottom: -11.31px;
    border-top-color: #FFF;
    border-bottom-width: 0;
  }
  fs-anchored-dialog[pointer-direction="left"] .fs-dialog-pointer {
   /* TODO: after we drop IE, change 11.31px to 16px */
    left: -11.31px;
    top: calc(50% - 11.31px);
    border-right-color: #FFF;
    border-left-width: 0;
  }
  fs-anchored-dialog[pointer-direction="right"] .fs-dialog-pointer {
   /* TODO: after we drop IE, change 11.31px to 16px */
    right: -11.31px;
    top: calc(50% - 11.31px);
    border-left-color: #FFF;
    border-right-width: 0;
  }
  fs-anchored-dialog[no-pointer] .fs-dialog-pointer {
    visibility: hidden;
    display: none;
  }

  @media screen and (max-width: 480px) {
    fs-anchored-dialog:not([no-fullscreen-mobile]) .fs-dialog-pointer {
      visibility: hidden;
      display: none;
    }
  }

</style>

<template id="fs-anchored-dialog-template">
  <div class="fs-dialog-pointer"></div>
</template>

<script>"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _createClass=function(){function t(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,o,i){return o&&t(e.prototype,o),i&&t(e,i),e}}(),_get=function t(e,o,i){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,o);if(void 0===n){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,o,i)}if("value"in n)return n.value;var a=n.get;if(void 0!==a)return a.call(i)};!function(){var t=(document._currentScript||document.currentScript).ownerDocument,e=t.querySelector("#fs-anchored-dialog-template"),o=FS.dialog.service.positioningObj,i="left",n="right",r="up",a="down",s="center",c="bottom",l="top",h="pointer-direction",d=22.62,p=11.31,f=16,u=25.62,b={persistent:"boolean","no-pointer":"boolean","attach-direction":"string",alignment:"string","forced-pointer-direction":"string","preferred-pointer-direction":"space separated array"},g={persistent:"persistent","no-pointer":"noPointer","attach-direction":"attachDirection",alignment:"alignment","forced-pointer-direction":"forcedPointerDirection","preferred-pointer-direction":"preferredPointerDirection"},y=["persistent","no-pointer","attach-direction","alignment","forced-pointer-direction","preferred-pointer-direction"],m=function(m){function v(){return _classCallCheck(this,v),_possibleConstructorReturn(this,(v.__proto__||Object.getPrototypeOf(v)).apply(this,arguments))}return _inherits(v,FS.dialog.baseDialogComponent),_createClass(v,[{key:"open",value:function(t){_get(v.prototype.__proto__||Object.getPrototypeOf(v.prototype),"open",this).call(this,t)}},{key:"close",value:function(){_get(v.prototype.__proto__||Object.getPrototypeOf(v.prototype),"close",this).call(this)}},{key:"attributeChangedCallback",value:function(t,e,o){_get(v.prototype.__proto__||Object.getPrototypeOf(v.prototype),"attributeChangedCallback",this).call(this,t,e,o)||y.some(function(e){if(t===e)return this[g[e]]="boolean"===b[e]?void 0!==o&&null!==o:void 0!==o&&null!==o?o:null,!0}.bind(this))}},{key:"connectedCallback",value:function(){this.attachedCallback()}},{key:"attachedCallback",value:function(){function b(t){if(window.addEventListener("resize",this._resizeThrottler),t=t||{},this.persistent?this.removeAttribute("dismiss-on-blur"):this.setAttribute("dismiss-on-blur",""),t.attachToCoordinates&&"number"==typeof t.attachToCoordinates.x&&"number"==typeof t.attachToCoordinates.y){var e=this.coordinateElement;e||(e=document.createElement("div"),document.body.appendChild(e),this.coordinateElement=e),e.style.position="absolute",e.style.left=t.attachToCoordinates.x+"px",e.style.top=t.attachToCoordinates.y+"px",t.attachToElement=e}t.attachToElement=t.attachToElement||document.activeElement,this.attachToElement=t.attachToElement;var s=this.querySelectorAll(".fs-dialog-pointer")[this.querySelectorAll(".fs-dialog-pointer").length-1];if(s.style.top="",s.style.left="",this.style.top="",this.style.left="",this.noPointer)this._positionDialogWithinDom(this,s,this._getPointerlessDialogRect(t),{left:0,top:0},"");else if(this.forcedPointerDirection){c=this._getRectsWithForcedDirection(t.attachToElement,this,s,this.forcedPointerDirection);this._positionDialogWithinDom(this,s,c.dialogRect,c.pointerRect,this.forcedPointerDirection)}else{var c,l=this.preferredPointerDirection?this.preferredPointerDirection.split(" "):[i,n,r,a],h=0,d=l[0],p=o.fsGetWindowRect(),f=this._getRectsWithForcedDirection(t.attachToElement,this,s,i),u=this._getRectsWithForcedDirection(t.attachToElement,this,s,n),b=this._getRectsWithForcedDirection(t.attachToElement,this,s,r),g=this._getRectsWithForcedDirection(t.attachToElement,this,s,a),y={};switch(y.left=o.fsCalculatePercentageVisible(f.dialogRect,p),y.right=o.fsCalculatePercentageVisible(u.dialogRect,p),y.up=o.fsCalculatePercentageVisible(b.dialogRect,p),y.down=o.fsCalculatePercentageVisible(g.dialogRect,p),l.every(function(t){return h<y[t]&&(d=t,h=y[t]),!0}),d){case i:c=f;break;case n:c=u;break;case r:c=b;break;case a:c=g}this._positionDialogWithinDom(this,s,c.dialogRect,c.pointerRect,d)}}function g(){window.removeEventListener("resize",this._resizeThrottler),this.attachToElement=null}function y(t,e,s){var c,l,h=t.top,f=t.left;switch(s){case r:case a:f=e.left+(e.width-d)/2,l=p,c=d;break;case i:case n:h=e.top+(e.height-d)/2,l=d,c=p}return new o.fsRect(f,h,c,l)}this.appendStyles(t,"style[data-fs-anchored-dialog]",this);var m=document.importNode(e.content,!0);this.appendChild(m),this.persistent?this.removeAttribute("dismiss-on-blur"):this.setAttribute("dismiss-on-blur",""),this._resizeHandler=function(t){var e=this.querySelector(".fs-dialog-pointer"),o=this,i=this.attachToElement,n=this.getAttribute(h);setTimeout(function(){if(o.noPointer)o._positionDialogWithinDom(o,e,o._getPointerlessDialogRect({attachToElement:i}),{left:0,top:0},"");else{var t=o._getRectsWithForcedDirection(i,o,e,n,!0);o._positionDialogWithinDom(o,e,t.dialogRect,t.pointerRect,n)}}.bind(this),0)}.bind(this),this._resizeThrottler=function(){_||(_=setTimeout(function(){_=null,this._resizeHandler()}.bind(this),66))}.bind(this),this._openAnchoredFunction=b.bind(this),this._closeAnchoredFunction=g.bind(this),this._getPointerlessDialogRect=function(t){var e,r,a,h=this.offsetParent||document.body,d=o.fsLocalToGlobal(t.attachToElement),p=this.offsetWidth,f=this.offsetHeight,u=0,b=0;if(h===document.body&&"static"!==window.getComputedStyle(document.body).position)b=(g=document.body.getBoundingClientRect()).left+window.pageXOffset;else if(h===document.body){var g=document.body.getBoundingClientRect();u=g.top+window.pageYOffset}switch(this.attachDirection){case c:case l:default:switch(this.alignment){case s:r=d.left-p/2+d.width/2-b;break;case n:r=d.left+d.width-p-b;break;case i:default:r=d.left-b}break;case i:case n:switch(this.alignment){case s:e=d.top-f/2+d.height/2+u;break;case l:default:e=d.top+u;break;case c:e=d.bottom+u-f}}switch(this.attachDirection){case c:default:e=d.bottom+u;break;case l:e=d.top+u-f;break;case i:r=d.left-p-b;break;case n:r=d.right-b}return a=new o.fsRect(r,e,p,f),a=o.fsGlobalToLocal(h,a)}.bind(this),this._positionDialogWithinDom=function(t,e,o,r,a){t.setAttribute(h,a),t.style.left=o.left+"px",t.style.top=o.top+"px",a===i||a===n?e.style.top=r.top-o.top+"px":e.style.left=r.left-o.left+"px"}.bind(this),this._getRectsWithForcedDirection=function(t,e,s,c,l){var h=o.fsGetWindowRect(),p=o.fsLocalToGlobal(t),b=e.offsetParent||document.body,g=o.fsLocalToLocal(t,b),m=o.fsLocalToLocal(s,b),v=o.fsLocalToLocal(e,b),_=e.offsetHeight,w=e.offsetWidth;if(b===document.body){var C=window.getComputedStyle(document.body).position,k=document.body.getBoundingClientRect().left+window.pageXOffset;"static"===C?(g=p,v=o.fsLocalToGlobal(e)):(g.left=g.left-k,v.left=v.left-k)}var D=g.left+g.width/2,R=g.top+g.height/2-_/2,T=D-w/2,P=p.left+p.width/2,E=p.top+p.height/2,O=E-_/2,W=E+_/2,F=P+w/2,j=P-w/2;return function(t,e,s,c,l){var h,d,p,f=y(s,c,l);switch(l){case r:case a:h=c.top+c.height+e,d=T+t,(p=new o.fsRect(d,h,w,_)).left>f.left-u?p.left=f.left-u:p.right<f.right+u&&(p.left=p.left+(f.right+u-p.right+u));break;case i:case n:d=c.left+c.width+t,h=R+e,(p=new o.fsRect(d,h,w,_)).top>f.top-u?p.top=f.top-u:p.bottom<f.bottom+u&&(p.top=p.top+(f.bottom+u-p.bottom))}return{dialogRect:p,pointerRect:f}}(this.xOffset=function(t){var e=0;switch(c){case r:case a:if(t)return(v.width-d)/2-parseFloat(s.style.left.split("px")[0]);F>h.right?e=-(F-h.right):j<h.left&&(e=Math.abs(j)+h.left);break;case i:e+=f;break;case n:e-=f,e-=g.width,e-=w}return e}.bind(this)(l),this.yOffset=function(t){var e=0;switch(c){case r:e+=f;break;case a:e-=f,e-=p.height,e-=_;break;case i:case n:if(t)return(v.height-d)/2-parseFloat(s.style.top.split("px")[0]);W>h.bottom?e=-(W-h.bottom):O<h.top&&(e=h.top-O)}return e}.bind(this)(l),m,g,c)}.bind(this),this._getNewPointerRect=y.bind(this),_get(v.prototype.__proto__||Object.getPrototypeOf(v.prototype),"attachedCallback",this).call(this,b,g);var _}},{key:"disconnectedCallback",value:function(){this.detachedCallback()}},{key:"detachedCallback",value:function(){this.coordinateElement&&(document.body.removeChild(this.coordinateElement),this.coordinateElement=null)}}],[{key:"properties",get:function(){return{opened:{type:Boolean,value:!1},alignment:{type:string,value:i},"forced-pointer-direction":{type:string,value:""},"preferred-pointer-direction":{type:string,value:"left right up down"},"no-pointer":{type:Boolean,value:!1},"attach-direction":{type:string,value:i},persistent:{type:Boolean,value:!1},"data-dialog-dismiss":{type:Boolean,value:!1},"data-dialog-confirm":{type:Boolean,value:!1},transition:{type:string,value:""},"no-fullscreen-mobile":{type:boolean,value:!1},"no-transition":{type:Boolean,value:!1},"no-close-button":{type:Boolean,value:!1}}}},{key:"observedAttributes",get:function(){return FS.dialog.baseDialogComponent.observedAttributes.concat(y)}}]),v}();"customElements"in window?customElements.define("fs-anchored-dialog",m):document.registerElement("fs-anchored-dialog",{prototype:Object.create(m.prototype)})}();</script>
