<link rel="import" href="../fs-globals/fs-globals.html">
<link rel="import" href="../a11y-enhancer/dialog.html">
<link rel="import" href="../inert/inert.html">

<script src="../fs-dialog/fs-dialog-service.js"></script>
<script src="../fs-dialog/get-root-node-polyfill.js"></script>
<style data-fs-dialog="">
  /*
   * 1. The display property cannot be animated so we need to use opacity and visibility
   *    to fade in
   *    @see https://stackoverflow.com/questions/3331353/transitions-on-the-display-property
   * 2. Delay the visibility property so we can see the dialog disappear
   *    @see https://codepen.io/matthewlein/pen/fvrLD
   * 3. Support a fixed modal header/footer and scrollable middle
   * 4. Temporary hack until fs-styles removes background image from fs-dialog__close
   * 5. Safari's default active button color seems to be white (activebuttontext)
   */
  fs-modeless-dialog,
  fs-modal-dialog,
  fs-anchored-dialog {
    background: #fff;
    border-radius: 4px;
    border-radius: var(--fs-border-radius, 4px);
    /* TODO: after we drop IE, bring back the filters */
    /*-webkit-filter: drop-shadow(0 0 7px rgba(0,0,0,0.5));
    filter: drop-shadow(0 0 7px rgba(0,0,0,0.5));*/
    /* TODO: after we drop IE, remove the box shadow */
    box-shadow: 0px 0px 4px 0px rgba(0,0,0,0.35), 0px 3px 2px 0px rgba(0,0,0,0.18);
    display: flex; /* [3] */
    flex-direction: column;
    max-height: 100vh;
    max-width: 545px;
    opacity: 0;
    position: fixed;
    visibility: hidden;
    width: 100%;
  }

  fs-modeless-dialog:not([no-transition]),
  fs-anchored-dialog:not([no-transition]) {
    transition: opacity 0.3s, visibility 0s linear 0.3s; /* [2] */
  }

  /* [1] */
  fs-modeless-dialog[opened],
  fs-modal-dialog[opened],
  fs-anchored-dialog[opened],
  .fs-dialog__mask[opened] {
    opacity: 1;
    visibility: visible;
  }

  fs-modeless-dialog[opened]:not([no-transition]),
  fs-anchored-dialog[opened]:not([no-transition]),
  .fs-dialog__mask[opened]:not([no-transition]) {
    transition: opacity 0.3s, visibility 0s linear;
  }

  fs-modal-dialog[opened] {
    transform: translate(-50%, -50%) scale(1);
  }

  fs-modal-dialog[opened]:not([no-transition]) {
    transition: opacity 0.3s, visibility 0s linear, transform 0.3s;
  }

  .fs-dialog__mask {
    background: rgba(51,51,49,0.8);
    bottom: 0;
    left: 0;
    opacity: 0;
    position: fixed;
    right: 0;
    top: 0;
    visibility: hidden;
  }

  .fs-dialog__mask:not([no-transition]) {
    transition: opacity 0.3s, visibility 0s linear 0.3s; /* [2] */
  }

  fs-anchored-dialog header,
  fs-modeless-dialog header,
  fs-modal-dialog header {
    /*border-bottom: 1px solid #ccc;
    border-bottom: 1px solid var(--fs-color-grey-border, #ccc);*/
    border-radius: 4px 4px 0 0;
    border-radius: var(--fs-border-radius, 4px) var(--fs-border-radius, 4px) 0 0;
    flex-shrink: 0;
    padding: 15px 15px 10px;
    background-color: #fff;
  }

  /* [4] */
  fs-anchored-dialog .fs-dialog__close,
  fs-modeless-dialog .fs-dialog__close,
  fs-modal-dialog .fs-dialog__close {
    background-image: none !important;
    -webkit-appearance: none;
    -webkit-touch-callout: none;
    background-color: transparent;
    background-position: center;
    background-repeat: no-repeat;
    border: none;
    box-shadow: 0 0 0 transparent;
    height: 22.75px;
    height: 1.625rem;
    line-height: 1;
    opacity: 0.5;
    padding: 0;
    position: absolute;
    right: 10px;
    right: 0.714rem;
    top: 10px;
    top: 0.714rem;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    width: 22.75px;
    width: 1.625rem;
    color: inherit; /* [5] */
    top: 15px;
    opacity: 1;
    z-index: 2;
  }

  fs-anchored-dialog .fs-dialog__close:hover,
  fs-modeless-dialog .fs-dialog__close:hover,
  fs-modal-dialog .fs-dialog__close:hover {
    cursor: pointer;
    opacity: 1;
  }

  fs-anchored-dialog .fs-dialog__close:active svg,
  fs-modeless-dialog .fs-dialog__close:active svg,
  fs-modal-dialog .fs-dialog__close:active svg {
    opacity: 1;
    width: 11px;
    height: 11px;
  }

  fs-anchored-dialog .fs-dialog__body,
  fs-modeless-dialog .fs-dialog__body,
  fs-modal-dialog .fs-dialog__body {
    flex-grow: 3;
    overflow-y: auto;
    padding: 15px;
    position: relative;
    background-color: #fff;
    z-index: 1;
  }

  fs-modal-dialog footer,
  fs-modeless-dialog footer,
  fs-anchored-dialog footer {
    /*background: #f4f4f4;
    background: var(--fs-color-grey-background-light, #f4f4f4);*/
    border-radius: 0 0 4px 4px;
    border-radius: 0 0 var(--fs-border-radius, 4px) var(--fs-border-radius, 4px);
    /*border-top: 1px solid #ccc;
    border-top: 1px solid var(--fs-color-grey-border, #ccc);*/
    flex-shrink: 0;
    padding: 10px 15px;
    background-color: #fff;
  }

  /** FULLSCREEN ON MOBILE **/
  /********* CAVEAT *********/
  /** This isn't going to  **/
  /** work on all dialogs  **/
  /** who have parents who **/
  /** are going to contain **/
  /** an absolute child    **/

  @media screen and (min-width:480px) {
    fs-modal-dialog[no-close-button] .fs-dialog__close,
    fs-anchored-dialog[no-close-button] .fs-dialog__close {
      display: none;
    }
  }
  @media screen and (max-width:480px) {
    fs-modal-dialog:not([no-fullscreen-mobile]),
    fs-anchored-dialog:not([no-fullscreen-mobile]) {
      border-radius: 0;
      top: 0 !important;
      left: 0 !important;
      bottom: 0 !important;
      right: 0 !important;
      transform: translate(0, 0) !important;
      max-height: 100% !important;
      height: 100% !important;
      position: fixed;
    }

    /** Mobile Transitions **/
    fs-anchored-dialog[transition]:not([no-fullscreen-mobile]) {
      transition: visibility 0s linear 0.3s, opacity 0s linear 0.3s;
    }
    fs-anchored-dialog[transition][opened]:not([no-fullscreen-mobile]) {
      transition: visibility 0s, opacity 0s;
    }

    fs-modal-dialog[transition="from-bottom"]:not([no-fullscreen-mobile]),
    fs-anchored-dialog[transition="from-bottom"]:not([no-fullscreen-mobile]) {
      top: 100% !important;
      transition: top 0.3s, visibility 0s linear 0.3s, opacity 0s linear 0.3s;
    }

    fs-modal-dialog[transition="from-bottom"][opened]:not([no-fullscreen-mobile]),
    fs-anchored-dialog[transition="from-bottom"][opened]:not([no-fullscreen-mobile]) {
      top: 0 !important;
      transition: top 0.3s;
    }

    fs-modal-dialog[transition="from-right"]:not([no-fullscreen-mobile]),
    fs-anchored-dialog[transition="from-right"]:not([no-fullscreen-mobile]) {
      left: 100% !important;
      transition: left 0.3s, visibility 0s linear 0.3s, opacity 0s linear 0.3s;
    }

    fs-modal-dialog[transition="from-right"][opened]:not([no-fullscreen-mobile]),
    fs-anchored-dialog[transition="from-right"][opened]:not([no-fullscreen-mobile]) {
      left: 0 !important;
      transition: left 0.3s;
    }
  }

  /** Mobile Transitions **/
  /** TODO: do we need  transitions when we are not on mobile? **/
 /* fs-modal-dialog[transition] {
    transition: visibility 0s linear 0.3s, opacity 0s linear 0.3s;
  }
  fs-modal-dialog[transition][opened] {
    transition: visibility 0s, opacity 0s;
  }

  fs-modal-dialog[transition="from-bottom"] {
    top: 100%;
    transform: translateX(-50%);
    transition: top 0.3s, visibility 0s linear 0.3s, opacity 0s linear 0.3s;
  }

  fs-modal-dialog[transition="from-bottom"][opened] {
    top: 50%;
    transform: translate(-50%, -50%);
    transition: top 0.3s;
  }

  fs-modal-dialog[transition="from-right"] {
    left: 100%;
    transform: translateY(-50%);
    transition: left 0.3s, visibility 0s linear 0.3s, opacity 0s linear 0.3s;
  }

  fs-modal-dialog[transition="from-right"][opened] {
    left: 50%;
    transform: translate(-50%, -50%);
    transition: left 0.3s;
  }*/
</style>

<!--
  This style will be appended to the body element when the first modal or anchored
  dialog is open.  When there is at least one modal open, the fs-modal-dialog-open
  class will be added to the body element.  When there is an anchored dialog open,
  the fs-anchored-dialog-open class will be added to the body element.
-->
<style id="fs-dialog-body-style">
    body.fs-modal-dialog-open {
      overflow: hidden !important;
    }

    @media screen and (max-width:480px) {
      body.fs-anchored-dialog-open {
        overflow: hidden !important;
      }
    }
</style>

<!-- 1. Since we're not using shadow DOM and can't use <slot> elements, we can only
        add siblings to the user nodes and cannot move their nodes (breaks binding
        for polymer and angular)
     2. Use inline svg so the color can be changed with the rest of the text inside
        the header -->
<template id="fs-dialog-template">

  <button class="fs-dialog__close" data-dialog-dismiss="">
    <svg aria-hidden="true" width="13" height="13" viewBox="0 0 13 13" preserveAspectRatio="xMidYMin"><g transform="translate(-1.000000, -1.000000)"><path d="M13 2L2 13M2 2L13 13" stroke="currentColor" stroke-width="2.5"></path></g></svg>
  </button>

</template>

<script>"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();!function(e,t){function i(e){for(var t=e.target;t!==this;)t.hasAttribute("data-dialog-dismiss")&&(this.dispatchEvent(new Event("fs-dialog-dismiss",{bubbles:!0})),e.stopPropagation(),this.close()),t.hasAttribute("data-dialog-confirm")&&(this.dispatchEvent(new Event("fs-dialog-confirm",{bubbles:!0})),e.stopPropagation()),t=t.parentElement}function n(i){if(27===i.which)this.close();else if("FS-MODELESS-DIALOG"!==this.tagName&&9===i.which){var n=function(e){return focusableElements=Array.prototype.filter.call(e.querySelectorAll(['a[href]:not([tabindex="-1"])','area[href]:not([tabindex="-1"])','input:not([disabled]):not([tabindex="-1"])','select:not([disabled]):not([tabindex="-1"])','textarea:not([disabled]):not([tabindex="-1"])','button:not([disabled]):not([tabindex="-1"])','iframe:not([tabindex="-1"])','object:not([tabindex="-1"])','embed:not([tabindex="-1"])','*[tabindex]:not([tabindex="-1"])','*[contenteditable]:not([tabindex="-1"])',"[focusable-component]"].join(",")),function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)}),focusableElements}(this);if(!n.length)return i.preventDefault();var o=n.indexOf(i.target)?n.indexOf(i.target):n.indexOf(e.ShadowDOMPolyfill&&e.ShadowDOMPolyfill.wrap?e.ShadowDOMPolyfill.wrap(t.activeElement):t.activeElement);i.shiftKey&&0===o?(n[n.length-1].focus(),i.preventDefault()):i.shiftKey||o!==n.length-1||(n[0].focus(),i.preventDefault())}}var o=(t._currentScript||t.currentScript).ownerDocument,s=o.querySelector("#fs-dialog-template");FS._registerTranslations();var a=!e.ActiveXObject&&"ActiveXObject"in e,r=function(e){e.style.height="",e.style.height=e.offsetHeight+"px"},l=990,c={"dismiss-on-blur":"boolean","no-fullscreen-mobile":"boolean",opened:"boolean"},u={"dismiss-on-blur":"dismissOnBlur","no-fullscreen-mobile":"noFullscreenMobile",opened:"opened"},d=["dismiss-on-blur","no-fullscreen-mobile","opened"],h=function(h){function f(){_classCallCheck(this,f);var e=_possibleConstructorReturn(this,(f.__proto__||Object.getPrototypeOf(f)).call(this));return e.keydownHandler=n,e}return _inherits(f,HTMLElement),_createClass(f,[{key:"createdCallback",value:function(){this.keydownHandler=n}},{key:"connectedCallback",value:function(){this.attachedCallback()}},{key:"appendStyles",value:function(e,t,i){var n=i.getRootNode();if("[object ShadowRoot]"===n.toString()&&!n.querySelector(t)){var o=e.querySelector(t).cloneNode(!0);n.appendChild(o)}}},{key:"attachedCallback",value:function(c,u){this.appendStyles(o,"style[data-fs-dialog]",this);var d,h,f=t.importNode(s.content,!0),b=f.querySelector(".fs-dialog__close"),v=this.querySelector(".fs-dialog__body"),g=this.querySelector("header");this.querySelector("footer");b.setAttribute("aria-label",FS.i18n("fs.shared.fsDialog.CLOSE")),g?g.appendChild(b):this.insertBefore(b,this.firstChild),t.querySelector("#fs-dialog-body-style")||t.querySelector("body").appendChild(o.querySelector("#fs-dialog-body-style").cloneNode(!0)),this.appendChild(f),this.setAttribute("role","dialog"),a11yEnhancer.dialog(this),this._focusoutHandler=function(i){var n,o=this;e.removeEventListener("focus",o._focusoutHandler),FS.dialog.service.dialogIsOnTop(o)&&(i.relatedTarget&&!i.relatedTarget.classList.contains("fs-dialog__mask")?FS.dialog.service.windowHasFocus?o.contains(i.relatedTarget)||(n=[].concat(FS.dialog.service.getStack().reverse())).some(function(e){return!(e.dismissOnBlur&&!e.contains(i.relatedTarget))||(e.cancelFocusback=!0,void e.close())}):e.addEventListener("focus",o._focusoutHandler):setTimeout(function(){var i=t.activeElement;FS.dialog.service.windowHasFocus?o.contains(i)||(n=[].concat(FS.dialog.service.getStack().reverse())).some(function(e){return!(e.dismissOnBlur&&!e.contains(i))||void e.close()}):e.addEventListener("focus",o._focusoutHandler)},0))}.bind(this),this.open=function(e){var o=new Promise(function(e,t){d=e,h=t}.bind(this));try{if(e=e||{},this.opened)return;this.doNotUseInStack||FS.dialog.service.addDialogToStack(this),this.focusBackElement=e.focusBackElement||t.activeElement,l+=10,this.style.zIndex=l,c&&c.bind(this)(e),this.removeAttribute("aria-hidden"),a&&(r(this),this._mutationsObserver=function(e){var t=e._mutationsObserver||new MutationObserver(function(t){t.forEach(function(t){r(e)})});return t.observe(e,{childList:!0,characterData:!0,subtree:!0}),t}(this)),this.setAttribute("opened",""),setTimeout(function(){this.opened&&(this.querySelector("[autofocus]")?this.querySelector("[autofocus]").focus():this.focus())}.bind(this),0);var s="FS-MODAL-DIALOG"===this.tagName?"fs-modal-dialog-open":"FS-ANCHORED-DIALOG"===this.tagName?"fs-anchored-dialog-open":"";s&&"FS-ANCHORED-DIALOG"===this.tagName&&this.noFullscreenMobile&&(s=""),s&&t.body.classList.add(s),this.addEventListener("click",i),this.addEventListener("keydown",n),this.dismissOnBlur&&this.addEventListener("focusout",this._focusoutHandler),v&&v.scrollHeight>v.clientHeight&&v.setAttribute("tabindex",0),this.dispatchEvent(new Event("fs-dialog-open",{bubbles:!0}))}catch(e){h(e)}return o},this.close=function(e){if(this.opened){if(this.dismissOnBlur&&this.removeEventListener("focusout",this._focusoutHandler),this.removeEventListener("click",i),this.removeEventListener("keydown",n),this.removeAttribute("opened"),this.setAttribute("aria-hidden",!0),a&&this._mutationsObserver&&this._mutationsObserver.disconnect(),u&&u.bind(this)(),l-=10,this.cancelFocusback||"FS-MODAL-DIALOG"!==this.tagName?(this.cancelFocusback||this.focusBackElement.focus(),this.cancelFocusback=!1,this.focusBackElement=null):setTimeout(function(){this.focusBackElement.focus(),this.cancelFocusback=!1,this.focusBackElement=null}.bind(this),100),FS.dialog.service.removeDialogFromStack(this),"FS-MODAL-DIALOG"===this.tagName||"FS-ANCHORED-DIALOG"===this.tagName){var o=this.tagName;0===FS.dialog.service.getStack().filter(function(e){return e.tagName===o&&!e.noFullscreenMobile}).length&&t.body.classList.remove("FS-MODAL-DIALOG"===this.tagName?"fs-modal-dialog-open":"FS-ANCHORED-DIALOG"===this.tagName?"fs-anchored-dialog-open":"")}return this.dispatchEvent(new Event("fs-dialog-close",{bubbles:!0})),d(),this.pendingPromise}},this.closeAndCloseChildren=function(){FS.dialog.service.closeDialogAndAllChildren(this)},this.hasAttribute("opened")&&this.open()}},{key:"attributeChangedCallback",value:function(e,t,i){return d.some(function(t){if(e===t)return this[u[t]]="boolean"===c[t]?void 0!==i&&null!==i:void 0!==i&&null!==i?i:null,!0}.bind(this))}}],[{key:"observedAttributes",get:function(){return d}}]),f}();e.addEventListener("focus",function(e){FS.dialog.service.windowHasFocus=!0}),e.addEventListener("blur",function(e){FS.dialog.service.windowHasFocus=!1}),FS.dialog.baseDialogComponent=h}(window,document);</script>
