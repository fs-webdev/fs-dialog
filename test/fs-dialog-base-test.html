<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../fs-globals/fs-globals-mock.js"></script>
    <script src="../../axe.min/index.js" ></script>
    <link rel="stylesheet" href="../../fs-styles/dist/familysearch-styles.css">


    <!-- Step 1: import the element to test -->
    <link rel="import" href="../fs-dialog-all.html">
  </head>
  <body>

    <!-- Use the document as a place to set up your fixtures. -->
    <test-fixture id="fs-dialog-fixture">
      <template>
        <fs-dialog>
          <header>
            <h4>Modal</h4>
          </header>
          <div class="fs-dialog__body">
            <p>This is a modal dialog. It really stands out from the content and forces the user to perform an action before they can continue.</p>
          </div>
          <footer>
            <button class="fs-button fs-button--recommended" data-dialog-confirm>Done</button>
            <button class="fs-button" data-dialog-dismiss>Cancel</button>
          </footer>
        </fs-dialog>
      </template>
    </test-fixture>

     <test-fixture id="fs-dialog-fixture-modeless">
      <template>
        <fs-dialog type="modeless">
          <header>
            <h4>Modal</h4>
          </header>
          <div class="fs-dialog__body">
            <p>This is a modal dialog. It really stands out from the content and forces the user to perform an action before they can continue.</p>
          </div>
          <footer>
            <button class="fs-button fs-button--recommended" data-dialog-confirm>Done</button>
            <button class="fs-button" data-dialog-dismiss>Cancel</button>
          </footer>
        </fs-dialog>
      </template>
    </test-fixture>

    <test-fixture id="fs-dialog-fixture-empty">
      <template>
        <fs-dialog></fs-dialog>
      </template>
    </test-fixture>

    <test-fixture id="fs-dialog-fixture-modeless-empty">
      <template>
        <fs-dialog type="modeless"></fs-dialog>
      </template>
    </test-fixture>

    <script>
    function simulateEvent(type, config) {
      var evt;

      try {
        evt = new Event(type);
      } catch(e) {
        evt = document.createEvent('Event');
        evt.initEvent(type, true, false);
      }

      var config = config || {};
      for (var prop in config) {
        evt[prop] = config[prop];
      }

      return evt;
    }

    describe('fs-dialog', function() {
      var el, closeEl, bodyEl, headerEl, footerEl, maskEl;

      function updateSelectors() {
        closeEl = el.querySelector('.fs-dialog__close');
        bodyEl = el.querySelector('.fs-dialog__body');
        headerEl = el.querySelector('header');
        footerEl = el.querySelector('footer');
        maskEl = el.parentNode.querySelector('.fs-dialog__mask');
      }

      beforeEach(function() {
        el = fixture('fs-dialog-fixture');
        updateSelectors();
      });

      afterEach(function() {
        el.close();
        el.remove();
      });





      describe('attached', function() {

        it('should add a close button with an aria-label', function() {
          expect(closeEl).to.exist;
          expect(closeEl.hasAttribute('aria-label')).to.be.true;
        });

        it('should move the close button to be in the header', function() {
          expect(closeEl.parentNode).to.equal(headerEl);
        });

        it('should move the close button to be the first child of the dialog if there is no header', function() {
          el = fixture('fs-dialog-fixture-empty');
          updateSelectors();

          expect(closeEl.parentNode).to.equal(el);
          expect(el.firstChild).to.equal(closeEl);
        });

      });





      describe('functions', function() {

        it('calling "open" should open the dialog', function() {
          el.open();

          expect(el.hasAttribute('opened')).to.be.true;
        });

        it('calling "open" should dispatch an "fs-dialog-open" event', function(done) {
          // timeout after 1 second if the event is not triggered
          this.timeout(1000);

          el.addEventListener('fs-dialog-open', function(e) {
            expect(e.target).to.equal(el);

            done();
          });

          el.open();
        });

        it('calling "open" should add "tabindex" to the body if it needs to scroll', function() {
          el.style.height = '200px';
          bodyEl.innerHTML = `<p>This dialogs content will scroll.</p>
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam eu auctor diam. Donec condimentum eleifend purus at lacinia. Cras feugiat sodales pulvinar. Curabitur a aliquet eros. Integer vitae suscipit justo, vel sagittis dui. Maecenas nec porttitor arcu. Maecenas consequat lacinia dui quis vestibulum. Sed cursus consectetur erat quis eleifend. Sed consectetur imperdiet dui, nec iaculis ante lacinia nec. Nullam at nunc sed mauris convallis eleifend. Phasellus at malesuada nisi. Maecenas purus mi, pellentesque nec enim ut, venenatis congue leo. Integer porttitor sem eu nunc ornare, ac aliquet augue gravida. Cras sit amet dolor nisl.</p>

    <p>Curabitur maximus, metus quis rutrum tristique, mi nunc condimentum nibh, sit amet luctus leo velit ultricies sem. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Pellentesque rutrum nec arcu et tincidunt. Maecenas varius convallis bibendum. Proin mattis arcu orci, id eleifend ex posuere et. Aenean faucibus scelerisque turpis, at bibendum urna sodales et. Mauris posuere ultricies nisl, sed tincidunt felis pretium ac. Suspendisse sollicitudin in lacus ut pharetra. Duis dapibus elementum sapien at scelerisque. Vivamus non ullamcorper velit, a eleifend metus. Proin velit lorem, feugiat ac justo et, congue eleifend risus.</p>

    <p>Aenean convallis commodo metus. Donec euismod neque velit, at accumsan velit vulputate gravida. Duis ultricies pellentesque ante at dignissim. Sed non turpis magna. Interdum et malesuada fames ac ante ipsum primis in faucibus. Nullam mollis sed eros vitae mattis. Suspendisse non blandit nisi. Etiam mattis sodales congue.</p>`;
          el.open();

          expect(bodyEl.getAttribute('tabindex')).to.equal('0');
        });

        it('calling "close" should close the dialog', function() {
          el.open();
          el.close();

          expect(el.hasAttribute('opened')).to.be.false;
        });

        it('calling "close" should dispatch an "fs-dialog-close" event', function(done) {
          // timeout after 1 second if the event is not triggered
          this.timeout(1000);

          el.addEventListener('fs-dialog-close', function(e) {
            expect(e.target).to.equal(el);

            done();
          });

          el.open();
          el.close();
        });

      });





      describe('attributes', function() {

        it('"opened" should open the dialog', function() {
          el.setAttribute('opened', '');

          expect(el.opened).to.be.true;
        });

        it('"opened=false" should close the dialog', function() {
          el.opened = true;
          el.opened = false;

          expect(el.opened).to.be.false;
        });

        it('clicking on an element with "data-dialog-dismiss" should close the dialog', function() {
          el.open();
          el.querySelector('button').click();

          el.querySelector('[data-dialog-dismiss]').click();
        });

        it('clicking on an element with "data-dialog-dismiss" should dispatch a "fs-dialog-dismiss" event', function(done) {
          // timeout after 1 second if the event is not triggered
          this.timeout(1000);

          el.addEventListener('fs-dialog-dismiss', function(e) {
            expect(e.target).to.equal(el);

            done();
          });

          el.open();
          el.querySelector('[data-dialog-dismiss]').click();
        });

        it('clicking on an element with "data-dialog-confirm" should not close the dialog', function() {
          el.open();
          el.querySelector('[data-dialog-confirm]').click();

          expect(el.hasAttribute('opened')).to.be.true;
        });

        it('clicking on an element with "data-dialog-confirm" should dispatch a "fs-dialog-confirm" event', function(done) {
          // timeout after 1 second if the event is not triggered
          this.timeout(1000);

          el.addEventListener('fs-dialog-confirm', function(e) {
            expect(e.target).to.equal(el);

            done();
          });

          el.open();
          el.querySelector('[data-dialog-confirm]').click();
        });

      });





      describe('properties', function() {

        it('should have an "opened" attribute', function() {
          expect(el.opened).to.exist;
          expect(el.opened).to.be.false;
        });

        it('"opened=true" should open the dialog', function() {
          el.opened = true;

          expect(el.hasAttribute('opened')).to.be.true;
        });

        it('"opened=false" should close the dialog', function() {
          el.opened = true;
          el.opened = false;

          expect(el.hasAttribute('opened')).to.be.false;
        });

      });





      describe('modal', function() {

        describe('attached', function() {

          it('should create a mask element', function() {
            expect(maskEl).to.exist;
          });

          it('should add "role=main" to the body if present', function() {
            expect(bodyEl.getAttribute('role')).to.equal('main');
          });

        });





        describe('functions', function() {

          it('calling "open" should open the mask', function() {
            el.open();

            expect(maskEl.hasAttribute('opened')).to.be.true;
          });

          it('calling "close" should close the mask', function() {
            el.open();
            el.close();

            expect(maskEl.hasAttribute('opened')).to.be.false;
          });

        });

      });





      describe('modeless', function() {

        beforeEach(function() {
          el = fixture('fs-dialog-fixture-modeless');
          updateSelectors();
        });

        describe('functions', function() {

          it('calling "open" should set the transform', function() {
            el.open();

            // have to look at the transform style because getComputedStyles.transform
            // returns a matrix instead of the css style
            expect(el.getAttribute('style').includes('transform: translate3d')).to.be.true;
          });

          it('should not change the transform if it already exists so the modal stays in the same place as when it closed', function() {
            var regex = /translate3d\(([^)]+)\)/;
            el.style.transform = 'translate3d(200px, 200px, 0)';

            el.open();
            expect(el.getAttribute('style').match(regex)[1]).to.equal('200px, 200px, 0px');
          });

        });





        describe('drag', function() {

          it('should allow dragging with "mousedown"', function() {
            el.open();

            var event = simulateEvent('mousedown', {button: 0, clientX: 10, clientY: 10});
            headerEl.dispatchEvent(event);

            expect(el._drag).to.exist;
          });

          it('should not drag with anything but the left mouse button', function() {
            el.open();

            var event = simulateEvent('mousedown', {button: 1, clientX: 10, clientY: 10});
            headerEl.dispatchEvent(event);

            expect(el._drag).to.not.exist;
          });

          it('should not allow drag if there is no header', function() {
            el = fixture('fs-dialog-fixture-modeless-empty');
            updateSelectors();

            el.open();

            var event = simulateEvent('mousedown', {button: 0, clientX: 10, clientY: 10});
            el.dispatchEvent(event);

            expect(el._drag).to.not.exist;
          });

          it('should update the transform when dragged', function() {
            var xPos, yPos;
            el.open();

            var event = simulateEvent('mousedown', {button: 0, clientX: 10, clientY: 10});
            headerEl.dispatchEvent(event);

            var event = simulateEvent('mousemove', {button: 0, clientX: 20, clientY: 20});
            window.dispatchEvent(event);

            expect(el._drag.xPos).to.not.equal(xPos);
            expect(el._drag.yPos).to.not.equal(yPos);
          });

          it('should not move the dialog outside the window', function() {
            el.open();

            var event = simulateEvent('mousedown', {button: 0, clientX: 0, clientY: 0});
            headerEl.dispatchEvent(event);

            var event = simulateEvent('mousemove', {button: 0, clientX: -100000, clientY: -10000});
            window.dispatchEvent(event);

            expect(el._drag.xPos).to.equal(0);
            expect(el._drag.yPos).to.equal(0);

            var event = simulateEvent('mousemove', {button: 0, clientX: 10000, clientY: 1000});
            window.dispatchEvent(event);

            expect(el._drag.xPos).to.equal(el._drag.maxX);
            expect(el._drag.yPos).to.equal(el._drag.maxY);
          });

          it('should stop drag on mouseup', function() {
            el.open();

            var event = simulateEvent('mousedown', {button: 0, clientX: 10, clientY: 10});
            headerEl.dispatchEvent(event);

            var event = simulateEvent('mouseup', {button: 0, clientX: 20, clientY: 20});
            window.dispatchEvent(event);

            expect(el._drag).to.not.exist;
          });

        });

      });

    });
    </script>
  </body>
</html>
